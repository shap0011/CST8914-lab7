<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Feedback form</title>
    <meta charset="utf-8" />
    <style>
      .control,
      fieldset {
        margin: 6px 0;
      }

      label {
        display: inline-block;
        width: 120px;
        vertical-align: top;
      }

      input + label {
        width: auto;
      }

      .error,
      .required {
        color: red;
      }

      fieldset ul {
        margin: 0;
      }

      /* Visually hidden utility for screen reader only instructions */
      .sr-only {
        position: absolute;
        height: 1px;
        width: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip-path: inset(50%);
        white-space: nowrap;
      }

      /* Clear, visible focus for keyboard users */
      :focus-visible {
        outline: 3px solid #ffbf47;
        outline-offset: 2px;
      }

      /* Error summary styling */
      fieldset.errors {
        border: 2px solid #c00;
        padding: 8px 12px;
        margin-bottom: 12px;
      }

      fieldset.errors legend {
        font-weight: bold;
        color: #c00;
      }

      fieldset.errors a {
        text-decoration: underline;
      }

      /* Make inline help text slightly muted for sighted users */
      .help {
        display: block;
        font-size: 0.95rem;
        color: #444;
        margin-left: 120px;
      }

      /* Success message (polite live region) */
      #status {
        display: none; /* hidden until success */
        background-color: #e6ffed;
        color: #006b3a;
        border: 1px solid #8fd19e;
        padding: 8px 12px;
        font-weight: 600;
      }

      #status.visible {
        display: block; /* shown when success */
      }
    </style>
  </head>

  <body>
    <h1>Feedback form</h1>

    <!-- Q2-3. Identifying required fields in text -->
    <p>
      <strong
        >All fields marked with
        <span class="required" aria-hidden="true">*</span> are required.</strong
      >
      <span class="sr-only"
        >Required fields are indicated by the word "required".</span
      >
    </p>

    <div id="status" role="status" aria-live="polite"></div>

    <!-- Added method/action for clarity; novalidate so our custom JS demo runs consistently -->
    <form method="get" action="" novalidate>
      <div class="control">
        <!-- Q2-1. Proper label association: add for/id.
             Q2-2. Indicate required in text & programmatically.
             Q2-4. Add required + aria-describedby for inline instructions. -->
        <label for="name"
          >Full name <span class="required" aria-hidden="true">*</span>
          <span class="sr-only">(required)</span></label
        ><input
          id="name"
          name="name"
          type="text"
          required
          autocomplete="name"
          aria-describedby="name_help"
        />
        <!-- Inline instruction visible and announced -->
        <span id="name_help" class="help">Enter your first and last name.</span>
      </div>
      <div class="control">
        <!-- Q2-1. Add for/id
             Q2-4. Connect help via aria-describedby -->
        <label for="biography"
          >Biography <span class="required" aria-hidden="true">*</span>
          <span class="sr-only">(required)</span></label
        ><textarea
          id="biography"
          name="biography"
          aria-describedby="bio-help"
        ></textarea>
        <span id="bio_help" class="help"
          >Include examples on your skills in JavaScript.</span
        >
      </div>

      <!-- Q2-2. & Q2-3. Group radios in a field/legend and indicate required in text -->
      <!-- Q2-1. Associate each radio with its label via for/id -->
      <fieldset class="control" aria-describedby="gender_help">
        <legend>
          Gender <span class="required" aria-hidden="true">*</span>
          <span class="sr-only">(required)</span>
        </legend>
        <!-- Q2-4. Inline instruction for SRs and visual -->
        <span id="gender_help" class="help">Choose one option.</span>

        <input id="gender_male" name="gender" type="radio" value="male" />
        <label for="gender_male">Male</label>

        <input id="gender_female" name="gender" type="radio" value="female" />
        <label for="gender_female">Female</label>
      </fieldset>

      <div class="control">
        <!-- Q2-1. Label connected to checkbox with for/id -->
        <input
          id="accept_agbs"
          name="accept_agbs"
          type="checkbox"
          value="1"
          aria-describedby="terms-help"
        />
        <label for="accept_agbs">I accept the terms and conditions</label>
        <span id="terms_help" class="help"
          >You must accept before registering</span
        >
      </div>

      <div class="control">
        <!-- Keep the original validate=1 mechanism so the URL-param demo works -->
        <input name="validate" type="hidden" value="1" />
        <input id="submitBtn" type="submit" value="Register" />
      </div>
    </form>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>

    <script>
      "use strict";

      (function () {
        var validateInput;

        // Helper to read URL param for this demo validation
        // Define a helper $.urlParam(name) that reads query-string parameters from the page URL
        $.urlParam = function (name) {
          var results = new RegExp("[?&]" + name + "=([^&#]*)").exec(
            window.location.href
          );
          if (results === null) return null;
          // Replace '+' with ' ' when retrieve name in text box
          return decodeURIComponent(results[1].replace(/\+/g, " ")) || null;
        };
        // };

        // Q3-2 & Q3-3: build an accessible error summary, link each message to its control,
        // Ensure focus moves to the summary. Also ensure aria-describedby exist.
        // Define validateInput(input, message) which:
        //  - if the parameter is missing -> creates/updates an error summary and links the error to the field;
        //  - if the parameter is present -> fills the field from the URL (so the form "remembers" entries)
        validateInput = function validateInput(input, message) {
          var $elementToDescribe,
            $error,
            $errorContainer,
            $fieldset,
            $input,
            $referencedElement,
            value;
          $input = $('[name="' + input + '"]'); // jQuery select by name

          if ((value = $.urlParam(input)) === null) {
            // MISSING value -> error mode
            // Create (once) a tabbable, live error summary at the top
            // Ensure an error summary exists at the top
            if ($("fieldset.errors").length === 0) {
              $("form").prepend(
                // Q3-2: role="alert" + aria-live assertively announces errors;
                // Q3-3: tabindex="-1" so we can programmatically focus the summary.
                '<fieldset class="errors" role="alert" aria-live="assertive" tabindex="-1">' +
                  '<legend id="error_legend">Errors</legend><ul></ul></fieldset>'
              );
            }

            // Find the <ul> inside the error summary fieldset
            $errorContainer = $("fieldset.errors ul");

            // Pick the element to describe + the element to focus
            if ($input.is(":radio")) {
              // For radio groups, describe the whole fieldset
              $fieldset = $input.closest("fieldset");
              $elementToDescribe = $fieldset.length ? $fieldset : $input;
              $referencedElement = $input.filter(":first"); // first radio will get focus
            } else {
              $elementToDescribe = $input; // describe this control
              $referencedElement = $input; // and focus it from the summary link
            }

            // Ensure the described-by element exists; create it if needed
            var descId = input + "_description";
            if ($("#" + descId).length === 0) {
              // Create a hidden description span and connect it
              var hiddenSpan = $(
                '<span id="' + descId + '" class="sr-only"></span>'
              );
              // Insert it after the control (or for radios, after the first radio)
              if ($input.is(":radio")) {
                $referencedElement.after(hiddenSpan);
              } else {
                $elementToDescribe.after(hiddenSpan);
              }
            }

            $elementToDescribe.attr("aria-describedby", function (i, val) {
              // Preserve any existing help ids (like *_help) by appending the error id
              return (val ? val + " " : "") + descId;
            });

            // Q3-2: FIX the “hint” line - make the summary item an anchor pointing to the control
            // If referenced element has no id, ensure it has one
            if (!$referencedElement.attr("id")) {
              $referencedElement.attr("id", input + "_field");
            }
            // R.G. hint: fix next line ;)
            $error = $(
              '<a href="#' +
                $referencedElement.attr("id") +
                '">' +
                message +
                "</a>"
            );

            // When clicking an error link, move focus to the referenced control
            $error.on("click", function (e) {
              // If we rely on the link's href pointing to the input's ID, it doesn't trigger forms mode in screen readers
              // Moving focus triggers forms/browse modes correctly in SRs
              $referencedElement.focus();
              e.preventDefault();
            });

            //$elementToDescribe.attr("aria-describedby", input + "_description");
            $errorContainer.append("<li>").find("li:last").append($error);

            //if ($(":not(form):focus").length === 0) {
            // See https://stackoverflow.com/questions/46134247/jquery-setting-focus-doesnt-work-in-ie11/
            //}
          } else {
            // PRESENT value -> fill the field
            // handle checkbox
            if ($input.is(":checkbox")) {
              $input.attr("checked", true);
            }

            // handle radio buttons
            if ($input.is(":radio")) {
              return $input
                .filter('[value="' + value + '"]')
                .attr("checked", true);
            } else {
              // handle all other input types
              return $input.val(value);
            }
          }
        };

        // When the page loads after pressing Register (method=get), run the validation
        $(document).ready(function () {
          if ($.urlParam("validate")) {
            // Clear previous status message
            $("#status").removeClass("visible").empty();

            // On $(document).ready(...):
            //  - check if ?validate=1 is in the URL,
            //  - run validateInput(...) for each field,
            //Q2-1..Q2-4 messages that also appear in the error summary
            validateInput("name", "Please enter your name!");
            validateInput(
              "biography",
              "Please tell us something about your history!"
            );
            validateInput("gender", "Please tell us your gender!");
            validateInput(
              "accept_agbs",
              "You must accept our terms and conditions!"
            );

            var hasErrors = $("fieldset.errors li").length > 0;

            if (hasErrors) {
              // Q3-3: Move focus to the error summary for keyboard and SR users
              // if any errors exist -> move focus to summary
              var $summary = $("fieldset.errors");
              // Add error count to legend for clarity
              var count = $("fieldset.errors li").length;
              $("#error_legend").text("Errors (" + count + ")");
              $summary.focus();

              // Ensure success message stays hidden if there are errors
              $("#status").removeClass("visible").empty();
            } else {
              // Q3-1: Only announce success when there are no errors
              // Show both the on-screen message and pop-up alert
              // Show visible success message only when all inputs are valid
              $("#status").addClass("visible").text("All inputs are valid.");
              alert("All inputs are valid.");
            }
          }
        });
      })();
    </script>
  </body>
</html>
